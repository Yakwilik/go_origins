
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>posts_mongo: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/pkg/repository/mongo/posts_mongo/comments.go (85.7%)</option>
				
				<option value="file1">gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/pkg/repository/mongo/posts_mongo/posts.go (86.8%)</option>
				
				<option value="file2">gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/pkg/repository/mongo/posts_mongo/posts_mongo.go (83.3%)</option>
				
				<option value="file3">gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/pkg/repository/mongo/posts_mongo/votes.go (82.4%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package posts_mongo

import (
        "gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/structs"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "gopkg.in/mgo.v2/bson"
        "time"
)

func (p *PostsMongo) AddComment(comment structs.Comment, postID primitive.ObjectID) (structs.Post, error) <span class="cov8" title="1">{
        post, err := p.findPostByID(postID)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">comment.Created = time.Now().Format("2006-01-02T15:04:05.000")
        comment.ID = primitive.NewObjectIDFromTimestamp(time.Now())
        if len(post.Comments) == 0 </span><span class="cov8" title="1">{
                comments := make([]structs.Comment, 0)
                comments = append(comments, comment)
                post.Comments = comments
                _, err := p.posts.UpdateByID(nil, postID, bson.M{"$set": bson.M{"comments": comments}})
                return post, err
        }</span>
        <span class="cov8" title="1">post.Comments = append(post.Comments, comment)
        _, err = p.posts.UpdateByID(nil, postID, bson.M{"$addToSet": bson.M{"comments": comment}})
        return post, err</span>
}

func (p *PostsMongo) DeleteComment(commentID, postID primitive.ObjectID, userID int) (structs.Post, error) <span class="cov8" title="1">{

        post, err := p.findPostByID(postID)
        if err != nil </span><span class="cov0" title="0">{
                return post, nil
        }</span>
        <span class="cov8" title="1">filter := bson.M{"_id": postID}

        action := bson.M{"$pull": bson.M{"comments": bson.M{"_id": commentID, "author.id": userID}}}
        up, err := p.posts.UpdateOne(nil, filter, action)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">if up.ModifiedCount == 0 &amp;&amp; post.Author.ID == userID </span><span class="cov8" title="1">{
                up, err = p.posts.UpdateOne(nil, filter, bson.M{"$pull": bson.M{"comments": bson.M{"_id": commentID}}})
                if err != nil </span><span class="cov0" title="0">{
                        return post, err
                }</span>
        }
        <span class="cov8" title="1">post, err = p.findPostByID(postID)
        return post, err</span>
}
</pre>
		
		<pre class="file" id="file1" style="display: none">package posts_mongo

import (
        "errors"
        "github.com/sirupsen/logrus"
        "gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/structs"
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "time"
)

var incAction = bson.M{"$inc": bson.M{"views": 1}}

func (p *PostsMongo) GetAllPosts() ([]structs.Post, error) <span class="cov8" title="1">{
        items := make([]structs.Post, 0)

        _, err := p.posts.UpdateMany(nil, bson.M{}, incAction)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">cur, err := p.posts.Find(nil, bson.M{}, nil)
        if err != nil </span><span class="cov0" title="0">{
                return items, err
        }</span>
        <span class="cov8" title="1">err = cur.All(nil, &amp;items)
        return items, err</span>
}

func (p *PostsMongo) PostsByCategory(category string) ([]structs.Post, error) <span class="cov8" title="1">{
        items := make([]structs.Post, 0)
        filter := bson.M{"category": category}

        _, err := p.posts.UpdateMany(nil, filter, incAction)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Println(err)
        }</span>
        <span class="cov8" title="1">cur, err := p.posts.Find(nil, filter, nil)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">err = cur.All(nil, &amp;items)
        return items, err</span>
}
func (p *PostsMongo) PostsByUsername(username string) ([]structs.Post, error) <span class="cov8" title="1">{
        items := make([]structs.Post, 0)
        filter := bson.M{"author.username": username}
        _, err := p.posts.UpdateMany(nil, filter, incAction)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Println(err)
        }</span>
        <span class="cov8" title="1">cur, err := p.posts.Find(nil, filter, nil)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        <span class="cov8" title="1">err = cur.All(nil, &amp;items)
        return items, err</span>
}

func (p *PostsMongo) CreateNewPost(data structs.NewPostData, author structs.Author) (structs.Post, error) <span class="cov8" title="1">{
        newPost := structs.Post{
                Author:           author,
                Category:         data.Category,
                Comments:         nil,
                Created:          time.Now().Format("2006-01-02T15:04:05.000"),
                CreatedUnix:      time.Now().Unix(),
                Score:            0,
                Text:             data.Text,
                URL:              data.URL,
                Title:            data.Title,
                Type:             data.Type,
                UpvotePercentage: 0,
                Views:            0,
                Votes:            nil,
        }

        one, err := p.posts.InsertOne(nil, newPost)
        newPost.ID = one.InsertedID.(primitive.ObjectID)

        return newPost, err
}</span>
func (p *PostsMongo) findPostByID(id primitive.ObjectID) (structs.Post, error) <span class="cov8" title="1">{
        item := structs.Post{}

        cur := p.posts.FindOne(nil, bson.M{"_id": id})
        if cur.Err() != nil </span><span class="cov8" title="1">{
                return item, cur.Err()
        }</span>

        <span class="cov8" title="1">err := cur.Decode(&amp;item)
        return item, err</span>
}

func (p *PostsMongo) GetPostByID(id primitive.ObjectID) (structs.Post, error) <span class="cov8" title="1">{
        item, err := p.findPostByID(id)
        if err != nil </span><span class="cov8" title="1">{
                return item, err
        }</span>
        <span class="cov8" title="1">_, err = p.posts.UpdateByID(nil, id, incAction)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Println(err)
        }</span>
        <span class="cov8" title="1">return item, nil</span>
}

func (p *PostsMongo) DeletePostByID(postID primitive.ObjectID, userID int) error <span class="cov8" title="1">{

        post, err := p.findPostByID(postID)
        if err != nil </span><span class="cov8" title="1">{
                return err
        }</span>
        <span class="cov8" title="1">if post.Author.ID != userID </span><span class="cov8" title="1">{
                return errors.New("you can`t delete this post")
        }</span>

        <span class="cov8" title="1">_, err = p.posts.DeleteOne(nil, bson.M{"_id": postID})
        return err</span>
}
</pre>
		
		<pre class="file" id="file2" style="display: none">package posts_mongo

import (
        "go.mongodb.org/mongo-driver/mongo"
)

type PostsMongo struct {
        client *mongo.Client
        posts  *mongo.Collection
}

func NewPostsMongo(client *mongo.Client, DB, postsCollection string) *PostsMongo <span class="cov8" title="1">{
        if client == nil </span><span class="cov8" title="1">{
                return nil
        }</span>
        <span class="cov8" title="1">collection := client.Database(DB).Collection(postsCollection)
        if collection == nil </span><span class="cov0" title="0">{
                return nil
        }</span>
        <span class="cov8" title="1">return &amp;PostsMongo{client: client, posts: collection}</span>

}
</pre>
		
		<pre class="file" id="file3" style="display: none">package posts_mongo

import (
        "github.com/sirupsen/logrus"
        "gitlab.com/vk-go/lectures-2022-2/06_databases/99_hw/redditclone/structs"
        "go.mongodb.org/mongo-driver/bson"
        "go.mongodb.org/mongo-driver/bson/primitive"
        "go.mongodb.org/mongo-driver/mongo"
        "go.mongodb.org/mongo-driver/mongo/options"
)

func (p *PostsMongo) FindVote(postID primitive.ObjectID, userID int) (bool, error) <span class="cov8" title="1">{
        posts := make([]structs.Post, 0)
        filter := bson.M{"_id": postID, "votes.user": userID}
        find, err := p.posts.Find(nil, filter)
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>
        <span class="cov8" title="1">err = find.All(nil, &amp;posts)
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>
        <span class="cov8" title="1">return !(len(posts) == 0), nil</span>
}

func (p *PostsMongo) UnVote(postID primitive.ObjectID, userID int) (structs.Post, error) <span class="cov8" title="1">{
        post, err := p.findPostByID(postID)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">if len(post.Votes) == 0 </span><span class="cov0" title="0">{
                return post, nil
        }</span>
        <span class="cov8" title="1">action := bson.M{"$pull": bson.M{"votes": bson.M{"user": userID}}}
        _, err = p.posts.UpdateByID(nil, postID, action)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">err = p.SetScoreAndPercentage(postID)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Println(err)
        }</span>
        <span class="cov8" title="1">post, err = p.findPostByID(postID)
        return post, err</span>
}
func (p *PostsMongo) Vote(postID primitive.ObjectID, vote structs.Vote) (structs.Post, error) <span class="cov8" title="1">{
        post, err := p.findPostByID(postID)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">if len(post.Votes) == 0 </span><span class="cov8" title="1">{
                votes := make([]structs.Vote, 0)
                votes = append(votes, vote)
                _, err := p.posts.UpdateByID(nil, postID, bson.M{"$set": bson.M{"votes": votes}})
                if err != nil </span><span class="cov0" title="0">{
                        return post, err
                }</span>
                <span class="cov8" title="1">err = p.SetScoreAndPercentage(postID)
                if err != nil </span><span class="cov0" title="0">{
                        logrus.Println(err)
                }</span>
                <span class="cov8" title="1">post.Score = vote.Vote
                post.Votes = votes
                return post, nil</span>
        }
        <span class="cov8" title="1">found, err := p.FindVote(postID, vote.User)
        if err != nil </span><span class="cov0" title="0">{
                return post, err
        }</span>
        <span class="cov8" title="1">if found </span><span class="cov8" title="1">{
                filter := bson.M{"_id": postID}
                arrayFilters := options.ArrayFilters{
                        Filters: []interface{}{bson.M{"vote.user": vote.User}},
                }
                updateOpts := options.UpdateOptions{
                        ArrayFilters: &amp;arrayFilters,
                }
                updateOpts.SetUpsert(true)
                _, err = p.posts.UpdateOne(nil, filter, bson.M{"$set": bson.M{"votes.$[vote]": vote}}, &amp;updateOpts)
                if err != nil </span><span class="cov0" title="0">{
                        return post, err
                }</span>
        } else<span class="cov8" title="1"> {
                _, err = p.posts.UpdateByID(nil, postID, bson.M{"$addToSet": bson.M{"votes": vote}})
                if err != nil </span><span class="cov0" title="0">{
                        return post, err
                }</span>
        }
        <span class="cov8" title="1">err = p.SetScoreAndPercentage(postID)
        if err != nil </span><span class="cov0" title="0">{
                logrus.Println(err)
        }</span>
        <span class="cov8" title="1">post, err = p.findPostByID(postID)
        return post, err</span>
}

func (p *PostsMongo) count(postID primitive.ObjectID, vote int) (int, error) <span class="cov8" title="1">{
        pipeline := mongo.Pipeline{}
        matchStage := bson.D{{"$match", bson.M{"_id": postID}}}
        unwindStage := bson.D{{"$unwind", "$votes"}}
        projectStage := bson.D{{"$project", bson.D{{"votes", 1}, {"_id", 0}}}}
        insideMatchStage := bson.D{{"$match", bson.M{"votes.vote": vote}}}
        groupStage := bson.D{{"$count", "score"}}
        pipeline = append(pipeline, matchStage)
        pipeline = append(pipeline, unwindStage)
        pipeline = append(pipeline, projectStage)
        pipeline = append(pipeline, insideMatchStage)
        pipeline = append(pipeline, groupStage)
        aggregate, err := p.posts.Aggregate(nil, pipeline)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>
        <span class="cov8" title="1">result := make([]bson.M, 0)
        err = aggregate.All(nil, &amp;result)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>
        <span class="cov8" title="1">if len(result) == 0 </span><span class="cov8" title="1">{
                return 0, nil
        }</span>
        <span class="cov8" title="1">count := int(result[0]["score"].(int32))
        return count, nil</span>
}

func (p *PostsMongo) getUpvotesCount(postID primitive.ObjectID) (int, error) <span class="cov8" title="1">{
        res, err := p.count(postID, 1)
        return res, err
}</span>

func (p *PostsMongo) getDownvotesCount(postID primitive.ObjectID) (int, error) <span class="cov8" title="1">{
        res, err := p.count(postID, -1)
        return res, err
}</span>

func (p *PostsMongo) getUpvotesDownVotesCount(postID primitive.ObjectID) (upvote, downvote int, err error) <span class="cov8" title="1">{
        upvote, err = p.getUpvotesCount(postID)
        if err != nil </span><span class="cov0" title="0">{
                return upvote, downvote, err
        }</span>
        <span class="cov8" title="1">downvote, err = p.getDownvotesCount(postID)
        return upvote, downvote, err</span>
}

func (p *PostsMongo) SetScore(postID primitive.ObjectID) error <span class="cov8" title="1">{
        upvotes, downvotes, err := p.getUpvotesDownVotesCount(postID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">_, err = p.posts.UpdateByID(nil, postID, bson.M{"$set": bson.M{"score": upvotes - downvotes}})
        return err</span>
}

func (p *PostsMongo) SetUpvotePercentage(postID primitive.ObjectID) error <span class="cov8" title="1">{
        upvotes, downvotes, err := p.getUpvotesDownVotesCount(postID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">totalVotes := upvotes + downvotes
        var percentage float32
        if totalVotes == 0 </span><span class="cov8" title="1">{
                percentage = 0
        }</span> else<span class="cov8" title="1"> {
                percentage = float32(100 * upvotes / totalVotes)
        }</span>
        <span class="cov8" title="1">_, err = p.posts.UpdateByID(nil, postID, bson.M{"$set": bson.M{"upvotePercentage": percentage}})
        return err</span>
}

func (p *PostsMongo) SetScoreAndPercentage(postID primitive.ObjectID) error <span class="cov8" title="1">{
        err := p.SetScore(postID)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        <span class="cov8" title="1">err = p.SetUpvotePercentage(postID)
        return err</span>
}
</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
